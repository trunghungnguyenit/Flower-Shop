{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ACER/Desktop/Flower-Shop/app/api/order/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport * as yup from 'yup';\r\nimport { OrderFormData } from '@/api/api.type';\r\n\r\n// Validation schema\r\nconst validationSchema = yup.object({\r\n  // 2.1. Th√¥ng tin ng∆∞·ªùi ƒë·∫∑t\r\n  senderName: yup\r\n    .string()\r\n    .required('T√™n ng∆∞·ªùi g·ª≠i l√† b·∫Øt bu·ªôc')\r\n    .min(2, 'T√™n ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±')\r\n    .max(50, 'T√™n kh√¥ng ƒë∆∞·ª£c qu√° 50 k√Ω t·ª±'),\r\n  senderPhone: yup\r\n    .string()\r\n    .required('S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi g·ª≠i l√† b·∫Øt bu·ªôc')\r\n    .matches(/^[0-9]+$/, 'S·ªë ƒëi·ªán tho·∫°i ch·ªâ ƒë∆∞·ª£c ch·ª©a s·ªë')\r\n    .length(10, 'S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ ƒë√∫ng 10 s·ªë'),\r\n  \r\n  // 2.2. Th√¥ng tin ƒë∆°n hoa\r\n  product: yup.string().required('S·∫£n ph·∫©m l√† b·∫Øt bu·ªôc'),\r\n  quantity: yup.number().required('S·ªë l∆∞·ª£ng l√† b·∫Øt bu·ªôc').min(1, 'S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0').integer('S·ªë l∆∞·ª£ng ph·∫£i l√† s·ªë nguy√™n'),\r\n  productPrice: yup.number().required('ƒê∆°n gi√° l√† b·∫Øt bu·ªôc').min(0, 'ƒê∆°n gi√° kh√¥ng ƒë∆∞·ª£c √¢m'),\r\n  extraServices: yup.array().of(yup.string()).optional(),\r\n  deliveryDate: yup.string().required('Ng√†y giao h√†ng l√† b·∫Øt bu·ªôc'),\r\n  deliveryTimeSlot: yup.string().optional(),\r\n  deliveryArea: yup.string().required('Khu v·ª±c giao h√†ng l√† b·∫Øt bu·ªôc').oneOf(['da-nang', 'quang-nam'], 'Ch·ªâ nh·∫≠n giao h√†ng khu v·ª±c ƒê√† N·∫µng & Qu·∫£ng Nam'),\r\n  totalAmount: yup.number().required('T·ªïng ti·ªÅn l√† b·∫Øt bu·ªôc').min(0, 'T·ªïng ti·ªÅn kh√¥ng ƒë∆∞·ª£c √¢m'),\r\n  \r\n  // 2.3. Th√¥ng tin ng∆∞·ªùi nh·∫≠n\r\n  receiverName: yup\r\n    .string()\r\n    .required('T√™n ng∆∞·ªùi nh·∫≠n l√† b·∫Øt bu·ªôc')\r\n    .min(2, 'T√™n ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±')\r\n    .max(50, 'T√™n kh√¥ng ƒë∆∞·ª£c qu√° 50 k√Ω t·ª±'),\r\n  receiverPhone: yup\r\n    .string()\r\n    .required('S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi nh·∫≠n l√† b·∫Øt bu·ªôc')\r\n    .matches(/^[0-9]+$/, 'S·ªë ƒëi·ªán tho·∫°i ch·ªâ ƒë∆∞·ª£c ch·ª©a s·ªë')\r\n    .length(10, 'S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ ƒë√∫ng 10 s·ªë'),\r\n  receiverAddress: yup.string().required('ƒê·ªãa ch·ªâ c·ª• th·ªÉ l√† b·∫Øt bu·ªôc').min(10, 'ƒê·ªãa ch·ªâ ph·∫£i c√≥ √≠t nh·∫•t 10 k√Ω t·ª±'),\r\n  cardMessage: yup.string().optional(),\r\n  \r\n  // 2.4. Ghi ch√∫\r\n  note: yup.string().optional(),\r\n  \r\n  // 2.5. Thanh to√°n\r\n  paymentMethod: yup.string().required('Ph∆∞∆°ng th·ª©c thanh to√°n l√† b·∫Øt bu·ªôc').oneOf(['qr-code', 'cash-on-delivery'], 'Ph∆∞∆°ng th·ª©c thanh to√°n kh√¥ng h·ª£p l·ªá'),\r\n});\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    // Parse request body\r\n    const body: OrderFormData = await request.json();\r\n    \r\n    // Validate with Yup\r\n    await validationSchema.validate(body, { abortEarly: false });\r\n\r\n    // Get Discord webhook URL from environment\r\n    const webhookUrl = process.env.DISCORD_WEBHOOK_URL;\r\n    if (!webhookUrl) {\r\n      return NextResponse.json(\r\n        { success: false, message: 'C·∫•u h√¨nh webhook kh√¥ng t·ªìn t·∫°i' },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // Format order message\r\n    const servicesText = body.extraServices && body.extraServices.length > 0 \r\n      ? body.extraServices.join(', ') \r\n      : 'Kh√¥ng c√≥ d·ªãch v·ª• th√™m';\r\n\r\n    const deliveryAreaText = body.deliveryArea === 'da-nang' ? 'ƒê√† N·∫µng' : 'Qu·∫£ng Nam';\r\n    const paymentMethodText = body.paymentMethod === 'qr-code' ? 'Qu√©t m√£ QR' : 'Tr·∫£ ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng';\r\n    \r\n    // Format delivery time - x·ª≠ l√Ω c·∫£ deliveryTimeSlot v√† deliveryDate\r\n    let deliveryTime = 'Ch∆∞a x√°c ƒë·ªãnh';\r\n    if (body.deliveryDate) {\r\n      const formattedDate = body.deliveryDate.split('-').reverse().join('/');\r\n      if (body.deliveryTimeSlot) {\r\n        deliveryTime = `${body.deliveryTimeSlot} ${formattedDate}`;\r\n      } else {\r\n        deliveryTime = formattedDate;\r\n      }\r\n    }\r\n\r\n    const discordMessage = `üå∏ **ƒê∆†N ƒê·∫∂T HOA M·ªöI** üå∏\r\n\r\n**üë§ TH√îNG TIN NG∆Ø·ªúI ƒê·∫∂T:**\r\n‚Ä¢ T√™n: ${body.senderName}\r\n‚Ä¢ SƒêT: ${body.senderPhone}\r\n\r\n**üå∫ TH√îNG TIN ƒê∆†N HOA:**\r\n‚Ä¢ S·∫£n ph·∫©m: ${body.product}\r\n‚Ä¢ S·ªë l∆∞·ª£ng: ${body.quantity}\r\n‚Ä¢ ƒê∆°n gi√°: ${body.productPrice?.toLocaleString('vi-VN')}ƒë\r\n‚Ä¢ D·ªãch v·ª• th√™m: ${servicesText}\r\n‚Ä¢ Th·ªùi gian giao: ${deliveryTime}\r\n‚Ä¢ Khu v·ª±c: ${deliveryAreaText}\r\n‚Ä¢ **T·ªïng ti·ªÅn: ${body.totalAmount?.toLocaleString('vi-VN')}ƒë**\r\n\r\n**üìç TH√îNG TIN NG∆Ø·ªúI NH·∫¨N:**\r\n‚Ä¢ T√™n: ${body.receiverName}\r\n‚Ä¢ SƒêT: ${body.receiverPhone}\r\n‚Ä¢ ƒê·ªãa ch·ªâ: ${body.receiverAddress}\r\n‚Ä¢ L·ªùi nh·∫Øn thi·ªáp: ${body.cardMessage || 'Kh√¥ng c√≥'}\r\n\r\n**üí≥ THANH TO√ÅN:** ${paymentMethodText}\r\n\r\n**üìù GHI CH√ö:** ${body.note || 'Kh√¥ng c√≥ ghi ch√∫'}\r\n\r\n‚è∞ **Th·ªùi gian ƒë·∫∑t:** ${new Date().toLocaleString('vi-VN')}`;\r\n\r\n    // Send to Discord webhook\r\n    const discordResponse = await fetch(webhookUrl, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify({\r\n        content: discordMessage,\r\n      }),\r\n    });\r\n\r\n    if (!discordResponse.ok) {\r\n      throw new Error('Kh√¥ng th·ªÉ g·ª≠i th√¥ng b√°o Discord');\r\n    }\r\n\r\n    return NextResponse.json({ success: true });\r\n\r\n  } catch (error) {\r\n    console.error('Order API Error:', error);\r\n    \r\n    if (error instanceof yup.ValidationError) {\r\n      // Return validation errors\r\n      const validationErrors = error.inner.map(err => ({\r\n        field: err.path,\r\n        message: err.message\r\n      }));\r\n      \r\n      return NextResponse.json(\r\n        { \r\n          success: false, \r\n          message: 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá',\r\n          errors: validationErrors\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n    \r\n    return NextResponse.json(\r\n      { success: false, message: 'C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω ƒë∆°n h√†ng' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}"],"names":[],"mappings":"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"}}]
}